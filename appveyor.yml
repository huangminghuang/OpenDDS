branches:
  only:
    - cmake

os: Visual Studio 2017

# environment variables
environment:
  api_token:
    secure: DHxkhTxK/jRV6jrgB/3uMZ/3dv77ijtnI0RdRU9kIoo=

clone_depth: 15

init:
  - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

install:
  - git clone -q -b cmake --depth 1 git://github.com/huangminghuang/ACE_TAO.git
  - cmake -Bbuild -H. -A %platform% -DACE_UNITY_BUILD=ON
platform:
  - x64

configuration:
  - Debug

build:
  parallel: true
  project: build/OpenDDS.sln

after_build:
  - 7z a %APPVEYOR_BUILD_FOLDER%\..\opendds_build.zip %APPVEYOR_BUILD_FOLDER% -xr!.git -xr!*.obj -xr!*.pdb
  - move %APPVEYOR_BUILD_FOLDER%\..\opendds_build.zip opendds_build.zip

artifacts:
  - path: opendds_build.zip
    name: opendds_build

test: off

deploy_script:
  - ps: |
        $git_origin = git remote get-url origin
        $headers = @{
          "Authorization" = "Bearer $env:api_token"
          "Content-type" = "application/json"
        }

        $body = @{
            accountName = $env:APPVEYOR_ACCOUNT_NAME
            projectSlug = "opendds-test"
            branch = "master"
            environmentVariables = @{
               "deploy_version" = $env:appveyor_build_version
               "platform" = $env:platform
               "configuration" = $env:configuration
               "travis_branch" = $env:appveyor_repo_branch
               "travis_commit" = $env:appveyor_repo_commit
               "travis_commit_message" = $env:appveyor_repo_commit_message
               "deploy_build_number" = $env:appveyor_build_number
               "deploy_job_number" = $env:appveyor_job_number
               "git_origin" = $git_origin
            }
        }
        $body = $body | ConvertTo-Json

        Invoke-RestMethod -Uri 'https://ci.appveyor.com/api/builds' -Headers $headers  -Body $body -Method POST
